import rospy
import numpy as np
from nav_msgs.msg import OccupancyGrid


class MapHandler:
    def __init__(self):
        self.map = None
        self.coord_map: np.ndarray
        self._map_sub = rospy.Subscriber("/map", OccupancyGrid, self._map_cb)

    def _map_cb(self, map):
        rospy.loginfo("MPPI MapHandler: got map")
        self.map = map

        width = self.map.info.width
        height = self.map.info.height
        self.coord_map = np.zeros(shape=(width, height, 3))  # x, y, occupancy_val

        for x_i in range(width):
            for y_i in range(height):
                self.coord_map[x_i, y_i, 0], self.coord_map[x_i, y_i, 1] = self.get_coords(x_i, y_i)
                self.coord_map[x_i, y_i, 2] = self.map.data[x_i * height + y_i]

        rospy.loginfo(self.coord_map[self.coord_map[:,:, 3] > 0])

    def get_coords(self, x_i, y_i):
        x = (x_i * self.map.info.resolution) + \
            self.map.info.origin.position.x + self.map.info.resolution / 2
        y = (y_i * self.map.info.resolution) + \
            self.map.info.origin.position.y + self.map.info.resolution / 2

        return [x, y]
